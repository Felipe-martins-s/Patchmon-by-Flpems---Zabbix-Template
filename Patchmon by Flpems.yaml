zabbix_export:
  version: '7.4'
  template_groups:
    - uuid: 3549a5f2b4d24a82ad3f828a62c17463
      name: SecurityMonitoring
  templates:
    - uuid: 87edab014619445da6c2d483d985b15e
      template: 'Patchmon by Flpems'
      name: 'Patchmon by Flpems'
      description: |
        ðŸ‡ºðŸ‡¸ English (Updated â€“ v2)
        
        PatchMon integration via HTTP Agent + LLD (Zabbix 7.4).
        
        Collects hosts list from {$PM_URL}/api/v1/api/hosts (Basic Auth: {$PM_KEY}/{$PM_SECRET}) and dynamically discovers each host (LLD) using {#PM_HOSTID}/{#PM_HOSTNAME}/{#PM_IP}/{#PM_FRIENDLY}/{#PM_GROUP}.
        
        Uses optimized Master + Dependent item architecture:
        
        1 master item for hosts list (1h)
        
        4 RAW master items per discovered host (30m: info/system/stats/integrations)
        
        All per-host metrics extracted via JSONPath/JavaScript preprocessing
        
        Per-host metrics: OS/version, kernel, SELinux, reboot pending, installed packages, repos, pending updates (total and security) and Docker metrics (enabled/containers/networks/volumes).
        
        Triggers:
        
        HIGH: PatchMon API unavailable (no data for 2h)
        
        Triggers Prototypes:
        
        HIGH: >=10 pending security updates
        
        AVERAGE: >=20 pending updates (depends on security trigger)
        
        Required macros: {$PM_URL}, {$PM_KEY}, {$PM_SECRET}.
        
        ðŸ‡§ðŸ‡· PortuguÃªs Brasil (Atualizado â€“ v2)
        
        IntegraÃ§Ã£o PatchMon via HTTP Agent + LLD (Zabbix 7.4).
        
        Coleta lista de hosts em {$PM_URL}/api/v1/api/hosts (Basic Auth: {$PM_KEY}/{$PM_SECRET}) e descobre dinamicamente cada host (LLD) usando {#PM_HOSTID}/{#PM_HOSTNAME}/{#PM_IP}/{#PM_FRIENDLY}/{#PM_GROUP}.
        
        Utiliza arquitetura otimizada Master + Dependent:
        
        1 item mestre para lista de hosts (1h)
        
        4 itens RAW por host descoberto (30m: info/system/stats/integrations)
        
        Demais mÃ©tricas extraÃ­das via JSONPath/JavaScript
        
        MÃ©tricas por host: OS/versÃ£o, kernel, SELinux, reboot pendente, pacotes instalados, repos, updates pendentes (total e security) e mÃ©tricas Docker (enabled/containers/networks/volumes).
        
        Triggers:
        
        HIGH: API PatchMon indisponÃ­vel (sem dados por 2h)
        
        Triggers Prototypes:
        
        HIGH: >=10 security updates pendentes
        
        AVERAGE: >=20 updates pendentes (depende do trigger de security)
        
        Requer macros: {$PM_URL}, {$PM_KEY}, {$PM_SECRET}.
      groups:
        - name: SecurityMonitoring
      items:
        - uuid: 116e141773424199bcc3fa0d20466e65
          name: 'PatchMon - Hosts list (raw)'
          type: HTTP_AGENT
          key: patchmon.hosts.raw
          delay: 1h
          value_type: TEXT
          authtype: BASIC
          username: '{$PM_KEY}'
          password: '{$PM_SECRET}'
          timeout: 30s
          url: '{$PM_URL}/api/v1/api/hosts'
          triggers:
            - uuid: ac4540b653e445cab98c8d85ddd856fc
              expression: 'nodata(/Patchmon by Flpems/patchmon.hosts.raw,2h)=1'
              name: 'Patchmon API availability: no data for 2h'
              priority: HIGH
      discovery_rules:
        - uuid: 25faf5db5d5040088c81759e05dfb86e
          name: 'PatchMon - Host discovery'
          type: DEPENDENT
          key: patchmon.host.discovery
          item_prototypes:
            - uuid: 2c4cf9e4df2845558d07df4350ed20ce
              name: 'Host {#PM_HOSTNAME} Docker Container Count'
              type: DEPENDENT
              key: 'patchmon.host.dckcnt[{#PM_HOSTID}]'
              value_type: FLOAT
              trends: '0'
              valuemap:
                name: 'Docker Count'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.integrations.docker.containers_count
                  error_handler: CUSTOM_VALUE
                  error_handler_params: '-1'
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 6h
              master_item:
                key: 'patchmon.host.integrations.raw[{#PM_HOSTID}]'
              tags:
                - tag: Info
                  value: 'Docker Containers Count'
                - tag: Source
                  value: Patchmon
            - uuid: 5f09d60ec17048569aebf27074204afd
              name: 'Host {#PM_HOSTNAME} Docker Integration Status'
              type: DEPENDENT
              key: 'patchmon.host.dckint[{#PM_HOSTID}]'
              value_type: TEXT
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.integrations.docker.enabled
                - type: STR_REPLACE
                  parameters:
                    - 'false'
                    - Disabled
                - type: STR_REPLACE
                  parameters:
                    - 'true'
                    - Enabled
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 6h
              master_item:
                key: 'patchmon.host.integrations.raw[{#PM_HOSTID}]'
              tags:
                - tag: Info
                  value: 'Docker Integration Status'
                - tag: Source
                  value: Patchmon
            - uuid: 7c1493178ee04049af4a1f4bfc43c357
              name: 'Host {#PM_HOSTNAME} Docker Networks Count'
              type: DEPENDENT
              key: 'patchmon.host.dckntwcnt[{#PM_HOSTID}]'
              value_type: FLOAT
              trends: '0'
              valuemap:
                name: 'Docker Count'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.integrations.docker.networks_count
                  error_handler: CUSTOM_VALUE
                  error_handler_params: '-1'
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 6h
              master_item:
                key: 'patchmon.host.integrations.raw[{#PM_HOSTID}]'
              tags:
                - tag: Info
                  value: 'Docker Networks Count'
                - tag: Source
                  value: Patchmon
            - uuid: e1e8b9e5296e43f58e563829f5c5dec6
              name: 'Host {#PM_HOSTNAME} Docker Volumes Count'
              type: DEPENDENT
              key: 'patchmon.host.dckvlcnt[{#PM_HOSTID}]'
              value_type: FLOAT
              trends: '0'
              valuemap:
                name: 'Docker Count'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.integrations.docker.volumes_count
                  error_handler: CUSTOM_VALUE
                  error_handler_params: '-1'
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 6h
              master_item:
                key: 'patchmon.host.integrations.raw[{#PM_HOSTID}]'
              tags:
                - tag: Info
                  value: 'Docker Volumes Count'
                - tag: Source
                  value: Patchmon
            - uuid: 46fa6240f9814d59a4f4b5cbc5226770
              name: 'Host {#PM_HOSTNAME} Info (raw)'
              type: HTTP_AGENT
              key: 'patchmon.host.info.raw[{#PM_HOSTID}]'
              delay: 30m
              value_type: TEXT
              authtype: BASIC
              username: '{$PM_KEY}'
              password: '{$PM_SECRET}'
              timeout: 30s
              url: '{$PM_URL}/api/v1/api/hosts/{#PM_HOSTID}/info'
              tags:
                - tag: Data
                  value: 'Info (raw)'
                - tag: Source
                  value: Patchmon
            - uuid: 91c394d847e34272b40eb76b895ca420
              name: 'Host {#PM_HOSTNAME} System OS/Version'
              type: DEPENDENT
              key: 'patchmon.host.info[{#PM_HOSTID}]'
              value_type: TEXT
              preprocessing:
                - type: JAVASCRIPT
                  parameters:
                    - |
                      var data = JSON.parse(value);
                      
                      var os = data.os_type ? data.os_type : "Unknown OS";
                      var ver = data.os_version ? data.os_version : "";
                      
                      return os + (ver ? " " + ver : "");
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 6h
              master_item:
                key: 'patchmon.host.info.raw[{#PM_HOSTID}]'
              tags:
                - tag: Info
                  value: 'OS Version'
                - tag: Source
                  value: Patchmon
            - uuid: 3dfa28a5b81f421295d0bf2f4bffd7d1
              name: 'Host {#PM_HOSTNAME} Integrations (raw)'
              type: HTTP_AGENT
              key: 'patchmon.host.integrations.raw[{#PM_HOSTID}]'
              delay: 30m
              value_type: TEXT
              authtype: BASIC
              username: '{$PM_KEY}'
              password: '{$PM_SECRET}'
              timeout: 30s
              url: '{$PM_URL}/api/v1/api/hosts/{#PM_HOSTID}/integrations'
              tags:
                - tag: Data
                  value: 'Integrations (raw)'
                - tag: Source
                  value: Patchmon
            - uuid: 68837063ebe44e9698d51279acc7eade
              name: 'Host {#PM_HOSTNAME} Kernel Version'
              type: DEPENDENT
              key: 'patchmon.host.krnversion[{#PM_HOSTID}]'
              value_type: TEXT
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.kernel_version
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 6h
              master_item:
                key: 'patchmon.host.system.raw[{#PM_HOSTID}]'
              tags:
                - tag: Info
                  value: 'Kernel Version'
                - tag: Source
                  value: Patchmon
            - uuid: 2ff5704685544ae1922a40bf173b49ee
              name: 'Host {#PM_HOSTNAME} Pending Updates: Total'
              type: DEPENDENT
              key: 'patchmon.host.pending_updates[{#PM_HOSTID}]'
              trends: '0'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.outdated_packages
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 1h
              master_item:
                key: 'patchmon.host.stats.raw[{#PM_HOSTID}]'
              tags:
                - tag: Info
                  value: Updates
                - tag: 'Pending Updates'
                  value: Total
                - tag: Source
                  value: Patchmon
              trigger_prototypes:
                - uuid: 681e5e65316b4372982bb67002f99bd9
                  expression: 'last(/Patchmon by Flpems/patchmon.host.pending_updates[{#PM_HOSTID}])>=20'
                  name: '{#PM_HOSTNAME} has more than 20 pending updates'
                  priority: AVERAGE
                  dependencies:
                    - name: '{#PM_HOSTNAME} has more than 10 pending security updates'
                      expression: 'last(/Patchmon by Flpems/patchmon.host.sec_updates[{#PM_HOSTID}])>=10'
            - uuid: 9457cb5c9a0140438f54427cdd13c520
              name: 'Host {#PM_HOSTNAME} Reboot Status'
              type: DEPENDENT
              key: 'patchmon.host.rbtstatus[{#PM_HOSTID}]'
              value_type: TEXT
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.needs_reboot
                - type: STR_REPLACE
                  parameters:
                    - 'false'
                    - 'No Reboot pending'
                - type: STR_REPLACE
                  parameters:
                    - 'true'
                    - 'Reboot pending'
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 6h
              master_item:
                key: 'patchmon.host.system.raw[{#PM_HOSTID}]'
              tags:
                - tag: Info
                  value: 'Reboot Status'
                - tag: Source
                  value: Patchmon
            - uuid: 776428d85c1f42e3a20e3e58a8fa818c
              name: 'Host {#PM_HOSTNAME} Total Repos'
              type: DEPENDENT
              key: 'patchmon.host.repos[{#PM_HOSTID}]'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.total_repos
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 6h
              master_item:
                key: 'patchmon.host.stats.raw[{#PM_HOSTID}]'
              tags:
                - tag: Info
                  value: 'Total Repos'
                - tag: Source
                  value: Patchmon
            - uuid: 348bb52fd05e4341b17849eb13340f1c
              name: 'Host {#PM_HOSTNAME} Pending Updates: Security'
              type: DEPENDENT
              key: 'patchmon.host.sec_updates[{#PM_HOSTID}]'
              trends: '0'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.security_updates
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 1h
              master_item:
                key: 'patchmon.host.stats.raw[{#PM_HOSTID}]'
              tags:
                - tag: Info
                  value: Updates
                - tag: 'Pending Updates'
                  value: Security
                - tag: Source
                  value: Patchmon
              trigger_prototypes:
                - uuid: 6797344241c64229974dcd674ff7947a
                  expression: 'last(/Patchmon by Flpems/patchmon.host.sec_updates[{#PM_HOSTID}])>=10'
                  name: '{#PM_HOSTNAME} has more than 10 pending security updates'
                  priority: HIGH
            - uuid: 8f738f853af44be8862be661bc807aae
              name: 'Host {#PM_HOSTNAME} SELinux Status'
              type: DEPENDENT
              key: 'patchmon.host.selstatus[{#PM_HOSTID}]'
              value_type: TEXT
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.selinux_status
                - type: DISCARD_UNCHANGED
              master_item:
                key: 'patchmon.host.system.raw[{#PM_HOSTID}]'
              tags:
                - tag: Info
                  value: 'SELinux Status'
                - tag: Source
                  value: Patchmon
            - uuid: 2fa0286a52e24f30b0c90cd882f46cea
              name: 'Host {#PM_HOSTNAME} Stats (raw)'
              type: HTTP_AGENT
              key: 'patchmon.host.stats.raw[{#PM_HOSTID}]'
              delay: 30m
              value_type: TEXT
              authtype: BASIC
              username: '{$PM_KEY}'
              password: '{$PM_SECRET}'
              timeout: 30s
              url: '{$PM_URL}/api/v1/api/hosts/{#PM_HOSTID}/stats'
              tags:
                - tag: Data
                  value: 'Stats (raw)'
                - tag: Source
                  value: Patchmon
            - uuid: 60830782603d49669138a81cac5a296f
              name: 'Host {#PM_HOSTNAME} Installed Packages'
              type: DEPENDENT
              key: 'patchmon.host.stats[{#PM_HOSTID}]'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.total_installed_packages
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 6h
              master_item:
                key: 'patchmon.host.stats.raw[{#PM_HOSTID}]'
              tags:
                - tag: Info
                  value: 'Installed Packages'
                - tag: Source
                  value: Patchmon
            - uuid: 3e129c4e13434557ba95f71c692567ed
              name: 'Host {#PM_HOSTNAME} System (raw)'
              type: HTTP_AGENT
              key: 'patchmon.host.system.raw[{#PM_HOSTID}]'
              delay: 30m
              value_type: TEXT
              authtype: BASIC
              username: '{$PM_KEY}'
              password: '{$PM_SECRET}'
              timeout: 30s
              url: '{$PM_URL}/api/v1/api/hosts/{#PM_HOSTID}/system'
              tags:
                - tag: Data
                  value: 'System (raw)'
                - tag: Source
                  value: Patchmon
          master_item:
            key: patchmon.hosts.raw
          lld_macro_paths:
            - lld_macro: '{#PM_FRIENDLY}'
              path: $.friendly_name
            - lld_macro: '{#PM_HOSTID}'
              path: $.id
            - lld_macro: '{#PM_HOSTNAME}'
              path: $.hostname
            - lld_macro: '{#PM_IP}'
              path: $.ip
          preprocessing:
            - type: JSONPATH
              parameters:
                - '$.hosts[*]'
      macros:
        - macro: '{$PM_KEY}'
          description: 'API user'
        - macro: '{$PM_SECRET}'
          description: 'API secret'
        - macro: '{$PM_URL}'
          description: 'PatchMon URL'
      valuemaps:
        - uuid: 93e2b50ba79f4f56a5c8fdbe7fbc4d48
          name: 'Docker Count'
          mappings:
            - value: '-1'
              newvalue: 'Integration disabled'
